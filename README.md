# Extra Milieux V0.3.3.2-BETA

<p><b>Суть проекта:</b> веб-приложение, которое позволит клиентам онлайн записываться к мастерам и салонам красоты на услуги. Мастера, в свою очередь, смогут определять предоставляемые услуги, определять свой рабочий график, вести учёт клиентов, отслеживать статистику своей работы.</p>

<hr>

<h2>Разворачивание приложения через Docker</h2>
<p>Быстрого разворачивания приложения без сложной настройки можно добиться через Docker</p>

<h3>Что нужно?</h3>
<ul>
<li>Установленный Docker на машину</li>
<li>docker-compose файл</li>
<li>Файл-скрипт инициализации базы данных</li>
<li>war-файл проекта</li>
</ul>

<h3>Убедитесь, что:</h3>
<ol>
<li>внутри war-файла по пути WEB-INF/classes в файле 
application.properties установлено значение <b style="color: #994444">spring.profiles.active=prod</b></li>
<li>Название файла строго <b style="color: #994444">ROOT.war</b></li>
</ol>

<h3>Разворачивание:</h3>
<ol>
<li>Выгрузите необходимые файлы в одно место на машине (compose-файл, sql-скрипт, war-файл)</li>
<li>В файле compose.yaml укажите пути к файлам .sql и .war (секция volumes)</li>
<li>Укажите папку, в которой будут находиться файлы mysql (они будут связаны с файлами виртуальной машины)</li>
<li>С помощью командной строки перейдите в директорию с compose-файлом и запустите команду 
<b style="color: #994444">docker-compose up -d</b></li>
</ol>

<hr>

<h2>Работа с Миграцией (FlyWay)</h2>
<p>В проекте есть механизм миграций, который позволяет применять изменения к существующей БД посредством версионируемых скриптов.</p>
<p>То есть. Если при выполнении задачи одному разработчику нужно было изменить структуру БД, то он создает файл sql с необходимыми изменениями и кладет его в определенную папку.
После чего механизм миграций применяет изменения.</p>
<p>Таким образом, мы избавляемся от необходимости каждый раз пересоздавать базу данных для каждого разработчика или заставлять их вручную выполнять скрипты</p>

<b><p>Фреймворк работает следующим образом:</p></b>
<ul>
<li>Проверяет схему базы данных на наличие таблицы метаданных (по умолчанию SCHEMA_VERSION). Если таблица метаданных не существует, то создает ее.</li>
<li>Сканирует classpath на наличие доступных миграций.</li>
<li>Сравнивает миграции с таблицей метаданных. Если номер версии меньше или равен версии, помеченной как текущая, то игнорирует ее.</li>
<li>Отмечает все оставшиеся миграции как ожидающие (pending). Потом сортирует их по возрастанию номеров версий и выполняет в указанном порядке.</li>
<li>По мере применения миграций обновляет таблицу метаданных.</li>
</ul>

<h3>Как с этим работать?</h3>
<h4>При первом запуске</h4>
<ol>
<li>Удостовериться, что в build.gradle указаны верные данные подключения к базе</li>
<li>Выполнить flywayClean</li>
<li>Выполнить flywayMigrate</li>
</ol>
<h4>При необходимости произвести миграцию</h4>
<ol>
<li>Выполнить flywayMigrate</li>
</ol>
<h2>Работа с JPA</h2>
<p>Возможно, при загрузке проекта в классах-моделях будет всплывать ошибка на аннотации "Table".</p>
<p>Возникновение ошибки связано с тем, что приложение не связано ни с каким источником данных, либо он не соответствует нужному источнику</p>
<h3>Что делать?</h3>
<ol>
<li>В Intellij Idea переходим через панель инструментов View->Tool Windows->Persistence</li>
<li>Появилась вкладка Persistence. Пока оставим её</li>
<li>В правой части экрана выберем вкладку Database</li>
<li>Далее необходимо настроить наш источник данных</li>
<li>Нажимаем значок "+" вверху вкладки и выбираем MySql</li>
<li>Вводим параметры пользователя, пароля и названия БД. Нажимаем Test connection</li>
<li>После успешной проверки возвращаемся на вкладку "Persistence"</li>
<li>Нажимаем правой кнопкой по имени проекта и выбираем Assign Data Sources</li>
<li>Из выпадающего меню выбираемм только что созданный DataSource</li>
</ol>